# Pentesting Guide for MCP Servers

This guide covers how to use the MCP Pentester CLI for security testing of Model Context Protocol implementations.

## Prerequisites

- Burp Suite Professional or Community Edition
- Basic understanding of JSON-RPC 2.0
- Authorization to test the target system
- Understanding of the MCP protocol specification

## Setup

### 1. Configure Burp Suite

```
Proxy > Options > Proxy Listeners
- Add: 127.0.0.1:8080
- Running: ✓

Proxy > Options > TLS Pass Through
- Add: *.example.com (if testing specific domains)

SSL > Client Certificates
- Add client cert if required by target
```

### 2. Build and Test the Tool

```bash
npm install
npm run build

# Test with a local server first
node dist/index.js connect \
  --transport stdio \
  --command npx \
  --args -y @modelcontextprotocol/server-filesystem /tmp
```

## Attack Scenarios

### 1. Authentication and Authorization Testing

#### Test: Authentication Bypass

Create config for direct connection:
```json
{
  "type": "https",
  "url": "https://api.target.com/mcp"
}
```

Create config for proxied connection:
```json
{
  "type": "https",
  "url": "https://api.target.com/mcp",
  "proxy": {
    "host": "127.0.0.1",
    "port": 8080
  }
}
```

Steps:
1. Connect and observe the initialization
2. In Burp, look for authentication tokens/headers
3. Try removing or modifying auth tokens
4. Attempt to call tools without proper authentication

#### Test: Session Management

1. Connect to the server
2. Capture the initialize request
3. Send it to Burp Repeater
4. Test session fixation, hijacking scenarios
5. Check if sessions timeout properly

### 2. Input Validation Testing

#### Test: Tool Parameter Injection

1. Navigate to Tools in the TUI
2. Intercept a `tools/call` request in Burp
3. Modify the arguments parameter:

```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "read_file",
    "arguments": {
      "path": "../../../../etc/passwd"
    }
  },
  "id": 1
}
```

Test for:
- Path traversal
- Command injection
- SQL injection (if tool uses database)
- XSS (if output is rendered)
- XXE (if XML processing involved)

#### Test: Resource URI Manipulation

Intercept `resources/read` requests:

```json
{
  "jsonrpc": "2.0",
  "method": "resources/read",
  "params": {
    "uri": "file:///etc/passwd"
  },
  "id": 2
}
```

Test URIs:
- `file://` schemes for local file access
- `http://` schemes for SSRF
- `ftp://`, `gopher://` for protocol smuggling
- Encoded characters `%2e%2e%2f`

### 3. Information Disclosure

#### Test: Error Message Information Leakage

1. Send malformed requests
2. Send requests with invalid types
3. Trigger edge cases

Look for:
- Stack traces
- File paths
- Internal IP addresses
- Software versions
- Database schema information

Example malformed request:
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "nonexistent_tool",
    "arguments": {"test": "' OR 1=1--"}
  },
  "id": 3
}
```

#### Test: Sensitive Data Exposure

1. List all resources
2. Check for sensitive information in:
   - Resource descriptions
   - Tool schemas
   - Prompt templates
   - Error messages

### 4. Protocol-Level Attacks

#### Test: JSON-RPC Batch Requests

Send multiple requests in a single batch:

```json
[
  {"jsonrpc": "2.0", "method": "tools/list", "id": 1},
  {"jsonrpc": "2.0", "method": "resources/list", "id": 2},
  {"jsonrpc": "2.0", "method": "tools/call", "params": {...}, "id": 3}
]
```

Check for:
- Race conditions
- Resource exhaustion
- Inconsistent state handling

#### Test: Notification Flooding

Send rapid notifications to test rate limiting:

```bash
# In Burp Intruder, send 1000 notifications
{
  "jsonrpc": "2.0",
  "method": "notifications/custom",
  "params": {"data": "test"}
}
```

#### Test: WebSocket-Specific Attacks

For WebSocket transports:
- Frame fragmentation attacks
- Message injection
- Connection hijacking
- Ping/Pong abuse

### 5. Business Logic Testing

#### Test: Unauthorized Tool Execution

1. List available tools
2. Identify privileged operations
3. Attempt to execute without proper authorization

Example:
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "admin_delete_user",
    "arguments": {"user_id": "1"}
  },
  "id": 4
}
```

#### Test: Resource Enumeration

1. Discover resource naming patterns
2. Attempt to access resources by guessing URIs
3. Test for IDOR (Insecure Direct Object Reference)

### 6. Denial of Service Testing

⚠️ **Warning**: Only perform with explicit authorization

#### Test: Large Payload Processing

Send oversized payloads:
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "process_data",
    "arguments": {
      "data": "A" * 10000000
    }
  },
  "id": 5
}
```

#### Test: Nested Object Processing

Send deeply nested JSON:
```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "process",
    "arguments": {
      "a": {"b": {"c": {"d": ... }}}
    }
  },
  "id": 6
}
```

### 7. Transport Security Testing

#### Test: TLS Configuration

For HTTPS/WSS transports:

1. Check cipher suites
2. Verify certificate validation
3. Test for downgrade attacks
4. Check for mixed content

Use Burp's SSL Scanner or external tools:
```bash
# Using testssl.sh
testssl.sh https://api.target.com/mcp

# Using nmap
nmap --script ssl-enum-ciphers -p 443 api.target.com
```

#### Test: Proxy Behavior

Test how the server handles proxied connections:

1. Add custom headers via proxy
2. Test `X-Forwarded-For` header injection
3. Check for proxy-specific vulnerabilities

## Burp Suite Workflow

### Recommended Extensions

- JSON Beautifier
- JSON Web Tokens
- Autorize (for authorization testing)
- Logger++ (for detailed logging)

### Burp Scanner Configuration

For active scanning:
1. Send interesting requests to Scanner
2. Configure scan settings for JSON-RPC
3. Review findings in Dashboard

### Repeater Workflow

1. Capture request in Proxy
2. Send to Repeater
3. Modify and resend
4. Compare responses
5. Document findings

### Intruder Payloads

Common payload positions:
- Method names
- Parameter values
- Resource URIs
- ID fields

Payload types:
- Fuzzing strings
- SQL injection
- XSS payloads
- Path traversal
- Command injection

## Testing Checklist

### Initial Reconnaissance
- [ ] Enumerate all available tools
- [ ] Enumerate all available resources
- [ ] Enumerate all available prompts
- [ ] Document server capabilities
- [ ] Identify authentication mechanisms

### Authentication/Authorization
- [ ] Test authentication bypass
- [ ] Test privilege escalation
- [ ] Test session management
- [ ] Test authorization controls

### Input Validation
- [ ] Test all tool parameters
- [ ] Test resource URIs
- [ ] Test prompt arguments
- [ ] Test JSON-RPC fields

### Information Disclosure
- [ ] Test error messages
- [ ] Check for debug information
- [ ] Review all responses for sensitive data
- [ ] Test for timing attacks

### Protocol Security
- [ ] Test JSON-RPC compliance
- [ ] Test batch processing
- [ ] Test notification handling
- [ ] Test connection handling

### Transport Security
- [ ] Verify TLS configuration
- [ ] Test certificate validation
- [ ] Check for secure defaults
- [ ] Test proxy handling

## Reporting Findings

### Severity Levels

**Critical**
- Remote code execution
- Authentication bypass
- SQL injection
- Arbitrary file read/write

**High**
- Privilege escalation
- IDOR with sensitive data access
- SSRF
- XSS in admin context

**Medium**
- Information disclosure
- Missing security headers
- Weak encryption
- CSRF

**Low**
- Information leakage (non-sensitive)
- Missing security features
- Configuration issues

### Report Template

```markdown
## Finding: [Title]

**Severity**: Critical/High/Medium/Low

**Description**:
[Detailed description of the vulnerability]

**Steps to Reproduce**:
1. Connect to server with: `node dist/index.js connect --config config.json`
2. Navigate to Tools
3. Send request: [JSON-RPC request]
4. Observe: [What happens]

**Proof of Concept**:
```json
[Request/Response showing the vulnerability]
```

**Impact**:
[What an attacker could do]

**Remediation**:
[How to fix the issue]

**References**:
- OWASP link
- CWE link
```

## Best Practices

1. **Always Get Authorization**: Only test systems you're authorized to test
2. **Document Everything**: Keep logs of all tests performed
3. **Use Staging First**: Test on staging environments before production
4. **Rate Limiting**: Don't overwhelm the server
5. **Clean Up**: Remove any test data created
6. **Responsible Disclosure**: Report findings appropriately

## Tools Integration

### With Metasploit

Export findings to Metasploit format for further exploitation.

### With OWASP ZAP

ZAP can also proxy JSON-RPC traffic. Configuration is similar to Burp.

### With Custom Scripts

The tool logs traffic that can be parsed by custom scripts:
- Extract all requests/responses
- Automate fuzzing
- Generate reports

## Legal and Ethical Considerations

⚠️ **Important**:
- Computer Fraud and Abuse Act (CFAA) in the US
- Computer Misuse Act in the UK
- Similar laws in other jurisdictions
- Always get written authorization
- Respect scope boundaries
- Don't test in production without approval
- Report vulnerabilities responsibly

## Additional Resources

- MCP Protocol Specification
- JSON-RPC 2.0 Specification
- OWASP Testing Guide
- Burp Suite Documentation
- Web Security Academy
